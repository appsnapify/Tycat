# üõ°Ô∏è **GUIA DEFINITIVO - SEGURAN√áA & BOAS PR√ÅTICAS DE C√ìDIGO**
## **DOCUMENTO ULTRA-COMPLETO PARA ZERO ERROS NO VIBE CODE**

---

## üéØ **OBJETIVO**
Criar o **documento mais completo** de regras de seguran√ßa e boas pr√°ticas para garantir **ZERO erros** no Codacy, **ZERO vulnerabilidades**, e **c√≥digo perfeito** em qualquer projeto.

---

## üìñ **√çNDICE**
1. [üö® REGRAS CR√çTICAS DE SEGURAN√áA](#regras-cr√≠ticas-de-seguran√ßa)
2. [üóÑÔ∏è DATABASE & SQL SECURITY](#database--sql-security)
3. [üîê AUTHENTICATION & AUTHORIZATION](#authentication--authorization)
4. [üìÅ FILE SYSTEM SECURITY](#file-system-security)
5. [üåê WEB & API SECURITY](#web--api-security)
6. [‚öõÔ∏è REACT/NEXT.JS ESPEC√çFICO](#reactnextjs-espec√≠fico)
7. [üêò POSTGRESQL/SUPABASE](#postgresqlsupabase)
8. [üßπ C√ìDIGO LIMPO & ESTRUTURA](#c√≥digo-limpo--estrutura)
9. [üîç INPUT VALIDATION](#input-validation)
10. [üìä LOGGING & MONITORING](#logging--monitoring)
11. [üê≥ DOCKER & DEPLOYMENT](#docker--deployment)
12. [üéØ CI/CD & AUTOMATION](#cicd--automation)
13. [üìã CHECKLISTS OBRIGAT√ìRIOS](#checklists-obrigat√≥rios)

---

## üö® **REGRAS CR√çTICAS DE SEGURAN√áA** <a name="regras-cr√≠ticas-de-seguran√ßa"></a>

### **‚ö° TOP 10 NUNCA VIOLAR - ZERO TOLER√ÇNCIA:**

#### **1. SQL Injection = MORTE INSTANT√ÇNEA**
```sql
-- ‚ùå MORTE INSTANT√ÇNEA: Concatena√ß√£o de strings
const query = "SELECT * FROM users WHERE id = " + userId;

-- ‚ùå MORTE INSTANT√ÇNEA: Template literals vulner√°veis
const query = `SELECT * FROM users WHERE name = '${userName}'`;

-- ‚úÖ VIDA ETERNA: Queries parametrizadas SEMPRE
const query = "SELECT * FROM users WHERE id = $1 AND name = $2";
const result = await db.query(query, [userId, userName]);
```

#### **2. GRANT ALL = PROIBIDO PARA SEMPRE**
```sql
-- ‚ùå NUNCA JAMAIS: GRANT ALL privileges
GRANT ALL ON schema.table TO role;
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO authenticated;

-- ‚úÖ SEMPRE: Permiss√µes espec√≠ficas por necessidade
GRANT SELECT, INSERT ON users TO authenticated;
GRANT EXECUTE ON FUNCTION get_user_profile(uuid) TO authenticated;
```

#### **3. RLS DESABILITADO = VULNERABILIDADE CR√çTICA**
```sql
-- ‚ùå PROIBIDO: Desabilitar RLS
ALTER TABLE users DISABLE ROW LEVEL SECURITY;

-- ‚úÖ OBRIGAT√ìRIO: RLS sempre ativo
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
CREATE POLICY "users_own_data" ON users FOR ALL TO authenticated USING (auth.uid() = id);
```

#### **4. Passwords Plain Text = GAME OVER**
```javascript
// ‚ùå GAME OVER: Plain text passwords
user.password = "123456";
const hash = crypto.createHash('md5').update(password).digest('hex');

// ‚úÖ SURVIVAL: bcrypt com salt forte
const saltRounds = 12; // M√≠nimo 12!
const hash = await bcrypt.hash(password, saltRounds);
const isValid = await bcrypt.compare(inputPassword, hash);
```

#### **5. eval() = C√ìDIGO MALICIOSO GARANTIDO**
```javascript
// ‚ùå C√ìDIGO MALICIOSO: eval com input usu√°rio
const userCode = req.body.code;
eval(userCode); // RCE vulnerability!

// ‚úÖ SEGURO: VM sandbox ou evitar completamente
const vm = require('vm');
const sandbox = { result: null, console: { log: () => {} } };
vm.runInContext(code, vm.createContext(sandbox), { timeout: 1000 });
```

---

## üóÑÔ∏è **DATABASE & SQL SECURITY** <a name="database--sql-security"></a>

### **üîí REGRAS ABSOLUTAS POSTGRESQL/SUPABASE**

#### **‚úÖ ESTRUTURA DE PERMISS√ïES PERFEITA:**
```sql
-- ‚úÖ 1. SEMPRE: Schema separation
CREATE SCHEMA app_data;
CREATE SCHEMA app_functions;
CREATE SCHEMA app_views;

-- ‚úÖ 2. SEMPRE: Role hierarchy
CREATE ROLE app_user;
CREATE ROLE app_admin;
CREATE ROLE app_service;

-- ‚úÖ 3. SEMPRE: Granular permissions
-- Users s√≥ podem ler seus pr√≥prios dados
GRANT SELECT ON app_data.user_profiles TO app_user;
GRANT INSERT, UPDATE ON app_data.user_profiles TO app_user;

-- Admins t√™m acesso controlado
GRANT SELECT ON ALL TABLES IN SCHEMA app_data TO app_admin;
GRANT EXECUTE ON ALL FUNCTIONS IN SCHEMA app_functions TO app_admin;

-- Services t√™m permiss√µes espec√≠ficas
GRANT SELECT, INSERT ON app_data.audit_logs TO app_service;
```

#### **‚úÖ RLS POLICIES BULLETPROOF:**
```sql
-- ‚úÖ SEMPRE: Policies espec√≠ficas por opera√ß√£o
CREATE POLICY "select_own_profile" ON user_profiles
FOR SELECT TO authenticated
USING (auth.uid() = user_id);

CREATE POLICY "insert_own_profile" ON user_profiles  
FOR INSERT TO authenticated
WITH CHECK (auth.uid() = user_id);

CREATE POLICY "update_own_profile" ON user_profiles
FOR UPDATE TO authenticated
USING (auth.uid() = user_id)
WITH CHECK (auth.uid() = user_id);

CREATE POLICY "admin_read_all" ON user_profiles
FOR SELECT TO app_admin
USING (true);

-- ‚úÖ SEMPRE: Policy para prevent data leakage
CREATE POLICY "prevent_email_enumeration" ON users
FOR SELECT TO authenticated
USING (
  CASE 
    WHEN auth.uid() = id THEN true
    ELSE email IS NULL OR email = ''
  END
);
```

#### **‚úÖ FUN√á√ïES SECURITY DEFINER PERFEITAS:**
```sql
-- ‚úÖ TEMPLATE DEFINITIVO para fun√ß√µes seguras
CREATE OR REPLACE FUNCTION get_user_dashboard(target_user_id uuid)
RETURNS jsonb
SECURITY DEFINER
SET search_path = public, app_data, app_functions
LANGUAGE plpgsql
AS $$
DECLARE
    result jsonb;
    current_user_id uuid;
BEGIN
    -- ‚úÖ 1. SEMPRE validar autentica√ß√£o
    current_user_id := auth.uid();
    IF current_user_id IS NULL THEN
        RETURN jsonb_build_object(
            'success', false, 
            'error', 'Authentication required',
            'code', 'AUTH_REQUIRED'
        );
    END IF;
    
    -- ‚úÖ 2. SEMPRE validar autoriza√ß√£o
    IF current_user_id != target_user_id THEN
        -- Log attempted access
        INSERT INTO audit_logs (user_id, action, details) 
        VALUES (current_user_id, 'UNAUTHORIZED_ACCESS_ATTEMPT', 
                jsonb_build_object('target_user', target_user_id));
                
        RETURN jsonb_build_object(
            'success', false,
            'error', 'Access denied',
            'code', 'ACCESS_DENIED'
        );
    END IF;
    
    -- ‚úÖ 3. SEMPRE validar inputs
    IF target_user_id IS NULL OR target_user_id = '00000000-0000-0000-0000-000000000000'::uuid THEN
        RETURN jsonb_build_object(
            'success', false,
            'error', 'Invalid user ID',
            'code', 'INVALID_INPUT'
        );
    END IF;
    
    -- ‚úÖ 4. L√≥gica de neg√≥cio com error handling
    BEGIN
        SELECT jsonb_build_object(
            'user_id', u.id,
            'email', u.email,
            'profile', p.data,
            'last_login', u.last_login_at
        ) INTO result
        FROM users u
        LEFT JOIN user_profiles p ON u.id = p.user_id
        WHERE u.id = target_user_id;
        
        -- ‚úÖ 5. SEMPRE verificar se dados existem
        IF result IS NULL THEN
            RETURN jsonb_build_object(
                'success', false,
                'error', 'User not found',
                'code', 'NOT_FOUND'
            );
        END IF;
        
        RETURN jsonb_build_object('success', true, 'data', result);
        
    EXCEPTION
        WHEN OTHERS THEN
            -- ‚úÖ 6. SEMPRE log errors sem expor detalhes
            INSERT INTO error_logs (user_id, function_name, error_message, error_detail)
            VALUES (current_user_id, 'get_user_dashboard', SQLERRM, SQLSTATE);
            
            RETURN jsonb_build_object(
                'success', false,
                'error', 'Internal server error',
                'code', 'INTERNAL_ERROR'
            );
    END;
END;
$$;

-- ‚úÖ SEMPRE: Revoke public access
REVOKE ALL ON FUNCTION get_user_dashboard FROM PUBLIC;
GRANT EXECUTE ON FUNCTION get_user_dashboard TO authenticated;
```

#### **‚ùå ANTI-PATTERNS MORTAIS:**
```sql
-- ‚ùå NUNCA: Dynamic SQL
CREATE FUNCTION bad_search(search_term text) RETURNS text AS $$
BEGIN
    EXECUTE 'SELECT * FROM users WHERE name = ''' || search_term || '''';
END;
$$ LANGUAGE plpgsql;

-- ‚ùå NUNCA: Functions sem SECURITY DEFINER
CREATE FUNCTION insecure_function() RETURNS text AS $$
-- Roda com privil√©gios do caller
$$ LANGUAGE sql;

-- ‚ùå NUNCA: Broad permissions
GRANT ALL ON ALL TABLES IN SCHEMA public TO authenticated;

-- ‚ùå NUNCA: RLS bypass sem justifica√ß√£o
ALTER TABLE sensitive_data DISABLE ROW LEVEL SECURITY;
```

---

## üîê **AUTHENTICATION & AUTHORIZATION** <a name="authentication--authorization"></a>

### **üõ°Ô∏è SISTEMA DE AUTH BULLETPROOF**

#### **‚úÖ PASSWORD SECURITY PERFEITA:**
```javascript
// ‚úÖ CONFIGURA√á√ÉO DEFINITIVA bcrypt
const bcrypt = require('bcrypt');

const PASSWORD_CONFIG = {
    saltRounds: 12, // M√≠nimo 12, idealmente 14+ para alta seguran√ßa
    maxLength: 128,
    minLength: 12
};

// ‚úÖ REGEX DEFINITIVO para passwords fortes
const PASSWORD_REGEX = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*()_+\-=\[\]{}|;:,.<>?])(?!.*\s).{12,128}$/;

// ‚úÖ FUN√á√ÉO DEFINITIVA de hash
async function hashPassword(plainPassword) {
    // Valida√ß√£o de input
    if (!plainPassword || typeof plainPassword !== 'string') {
        throw new Error('Password must be a non-empty string');
    }
    
    if (plainPassword.length < PASSWORD_CONFIG.minLength) {
        throw new Error(`Password must be at least ${PASSWORD_CONFIG.minLength} characters`);
    }
    
    if (plainPassword.length > PASSWORD_CONFIG.maxLength) {
        throw new Error(`Password must be less than ${PASSWORD_CONFIG.maxLength} characters`);
    }
    
    if (!PASSWORD_REGEX.test(plainPassword)) {
        throw new Error('Password does not meet complexity requirements');
    }
    
    // Hash seguro
    return await bcrypt.hash(plainPassword, PASSWORD_CONFIG.saltRounds);
}

// ‚úÖ FUN√á√ÉO DEFINITIVA de verifica√ß√£o
async function verifyPassword(plainPassword, hashedPassword) {
    if (!plainPassword || !hashedPassword) {
        return false;
    }
    
    try {
        return await bcrypt.compare(plainPassword, hashedPassword);
    } catch (error) {
        // Log security event
        logger.security('Password verification failed', { error: error.message });
        return false;
    }
}
```

#### **‚úÖ JWT SECURITY DEFINITIVA:**
```javascript
// ‚úÖ JWT CONFIGURATION PERFEITA
const JWT_CONFIG = {
    accessTokenExpiry: '15m',
    refreshTokenExpiry: '7d',
    issuer: 'your-app-name',
    audience: 'your-app-users',
    algorithm: 'HS256'
};

// ‚úÖ FUN√á√ÉO DEFINITIVA para criar JWT
function createTokens(payload) {
    const accessToken = jwt.sign(
        {
            ...payload,
            type: 'access',
            iat: Math.floor(Date.now() / 1000)
        },
        process.env.JWT_ACCESS_SECRET,
        {
            expiresIn: JWT_CONFIG.accessTokenExpiry,
            issuer: JWT_CONFIG.issuer,
            audience: JWT_CONFIG.audience,
            algorithm: JWT_CONFIG.algorithm
        }
    );
    
    const refreshToken = jwt.sign(
        {
            userId: payload.userId,
            type: 'refresh',
            iat: Math.floor(Date.now() / 1000)
        },
        process.env.JWT_REFRESH_SECRET,
        {
            expiresIn: JWT_CONFIG.refreshTokenExpiry,
            issuer: JWT_CONFIG.issuer,
            audience: JWT_CONFIG.audience,
            algorithm: JWT_CONFIG.algorithm
        }
    );
    
    return { accessToken, refreshToken };
}

// ‚úÖ MIDDLEWARE DEFINITIVO de autentica√ß√£o
const authenticateToken = async (req, res, next) => {
    const authHeader = req.headers['authorization'];
    const token = authHeader && authHeader.split(' ')[1];
    
    if (!token) {
        logger.security('Missing authentication token', { 
            ip: req.ip, 
            userAgent: req.get('User-Agent'),
            endpoint: req.path
        });
        return res.status(401).json({ 
            error: 'Authentication required',
            code: 'AUTH_REQUIRED'
        });
    }
    
    try {
        const decoded = jwt.verify(token, process.env.JWT_ACCESS_SECRET, {
            issuer: JWT_CONFIG.issuer,
            audience: JWT_CONFIG.audience
        });
        
        if (decoded.type !== 'access') {
            throw new Error('Invalid token type');
        }
        
        req.user = decoded;
        next();
    } catch (error) {
        logger.security('Invalid authentication token', { 
            ip: req.ip,
            error: error.message,
            endpoint: req.path
        });
        
        return res.status(403).json({ 
            error: 'Invalid or expired token',
            code: 'INVALID_TOKEN'
        });
    }
};
```

#### **‚úÖ RATE LIMITING ANTI-BRUTE FORCE:**
```javascript
// ‚úÖ RATE LIMITING DEFINITIVO
const rateLimit = require('express-rate-limit');
const slowDown = require('express-slow-down');

// ‚úÖ Rate limiter agressivo para login
const loginLimiter = rateLimit({
    windowMs: 15 * 60 * 1000, // 15 minutos
    max: 5, // M√°ximo 5 tentativas por IP
    message: {
        error: 'Too many login attempts',
        retryAfter: 15,
        code: 'RATE_LIMITED'
    },
    standardHeaders: true,
    legacyHeaders: false,
    handler: (req, res) => {
        logger.security('Rate limit exceeded for login', {
            ip: req.ip,
            userAgent: req.get('User-Agent')
        });
        res.status(429).json({
            error: 'Too many login attempts',
            retryAfter: 15,
            code: 'RATE_LIMITED'
        });
    }
});

// ‚úÖ Slow down progressivo
const speedLimiter = slowDown({
    windowMs: 15 * 60 * 1000, // 15 minutos
    delayAfter: 2, // Slow down ap√≥s 2 requests
    delayMs: 500 // Adicionar 500ms delay a cada request
});

// ‚úÖ Account lockout por user
const accountLockout = new Map();

const checkAccountLockout = (req, res, next) => {
    const { email } = req.body;
    const attempts = accountLockout.get(email) || { count: 0, lockUntil: 0 };
    
    if (attempts.lockUntil > Date.now()) {
        const remainingTime = Math.ceil((attempts.lockUntil - Date.now()) / 1000 / 60);
        logger.security('Account locked - access attempt', { email, ip: req.ip });
        
        return res.status(423).json({
            error: `Account locked. Try again in ${remainingTime} minutes`,
            code: 'ACCOUNT_LOCKED'
        });
    }
    
    req.accountAttempts = attempts;
    next();
};

const updateAccountAttempts = (email, success) => {
    if (success) {
        accountLockout.delete(email);
    } else {
        const attempts = accountLockout.get(email) || { count: 0, lockUntil: 0 };
        attempts.count++;
        
        if (attempts.count >= 5) {
            attempts.lockUntil = Date.now() + (30 * 60 * 1000); // Lock por 30 min
            logger.security('Account locked due to failed attempts', { email });
        }
        
        accountLockout.set(email, attempts);
    }
};
```

---

## üìÅ **FILE SYSTEM SECURITY** <a name="file-system-security"></a>

### **üõ°Ô∏è PATH TRAVERSAL PREVENTION DEFINITIVA**

#### **‚úÖ VALIDA√á√ÉO DE PATH BULLETPROOF:**
```javascript
const path = require('path');
const fs = require('fs').promises;

// ‚úÖ WHITELIST definitiva de extens√µes permitidas
const ALLOWED_EXTENSIONS = new Set([
    '.jpg', '.jpeg', '.png', '.gif', '.webp',
    '.pdf', '.doc', '.docx', '.txt',
    '.csv', '.xlsx'
]);

// ‚úÖ BLACKLIST definitiva de extens√µes perigosas
const DANGEROUS_EXTENSIONS = new Set([
    '.exe', '.bat', '.cmd', '.sh', '.ps1',
    '.js', '.php', '.jsp', '.asp', '.py',
    '.rb', '.pl', '.lua', '.vbs', '.scr'
]);

// ‚úÖ FUN√á√ÉO DEFINITIVA de valida√ß√£o de path
function validateFilePath(filePath, allowedDirectory) {
    try {
        // 1. Normalizar path
        const normalizedPath = path.normalize(filePath);
        
        // 2. Detectar path traversal
        if (normalizedPath.includes('..') || 
            normalizedPath.includes('~') ||
            normalizedPath.includes('\\') ||
            normalizedPath.startsWith('/')) {
            throw new Error('Path traversal detected');
        }
        
        // 3. Resolver paths absolutos
        const absoluteFilePath = path.resolve(allowedDirectory, normalizedPath);
        const absoluteAllowedDir = path.resolve(allowedDirectory);
        
        // 4. Verificar se est√° dentro do diret√≥rio permitido
        if (!absoluteFilePath.startsWith(absoluteAllowedDir + path.sep)) {
            throw new Error('File outside allowed directory');
        }
        
        // 5. Validar extens√£o
        const extension = path.extname(normalizedPath).toLowerCase();
        
        if (DANGEROUS_EXTENSIONS.has(extension)) {
            throw new Error('File type not allowed');
        }
        
        if (!ALLOWED_EXTENSIONS.has(extension)) {
            throw new Error('File type not supported');
        }
        
        // 6. Validar nome do arquivo
        const filename = path.basename(normalizedPath);
        const filenameRegex = /^[a-zA-Z0-9._-]+$/;
        
        if (!filenameRegex.test(filename)) {
            throw new Error('Invalid filename characters');
        }
        
        if (filename.length > 255) {
            throw new Error('Filename too long');
        }
        
        return absoluteFilePath;
        
    } catch (error) {
        logger.security('File path validation failed', {
            filePath,
            allowedDirectory,
            error: error.message
        });
        throw error;
    }
}

// ‚úÖ FUN√á√ÉO DEFINITIVA para leitura segura de arquivos
async function readFileSecurely(filePath, allowedDirectory, maxSize = 10 * 1024 * 1024) {
    try {
        // Validar path
        const validatedPath = validateFilePath(filePath, allowedDirectory);
        
        // Verificar se arquivo existe
        const stats = await fs.stat(validatedPath);
        
        // Verificar tamanho
        if (stats.size > maxSize) {
            throw new Error('File too large');
        }
        
        // Verificar se √© realmente um arquivo
        if (!stats.isFile()) {
            throw new Error('Not a file');
        }
        
        // Ler arquivo
        return await fs.readFile(validatedPath);
        
    } catch (error) {
        logger.security('Secure file read failed', {
            filePath,
            error: error.message
        });
        throw error;
    }
}

// ‚úÖ UPLOAD DE ARQUIVOS SEGURO
const multer = require('multer');
const crypto = require('crypto');

const secureStorage = multer.diskStorage({
    destination: (req, file, cb) => {
        const uploadDir = path.join(__dirname, '../uploads', req.user.id);
        fs.mkdir(uploadDir, { recursive: true })
            .then(() => cb(null, uploadDir))
            .catch(err => cb(err));
    },
    filename: (req, file, cb) => {
        // Gerar nome √∫nico e seguro
        const uniqueName = crypto.randomUUID();
        const extension = path.extname(file.originalname).toLowerCase();
        
        // Validar extens√£o
        if (!ALLOWED_EXTENSIONS.has(extension)) {
            return cb(new Error('File type not allowed'));
        }
        
        cb(null, `${uniqueName}${extension}`);
    }
});

const uploadLimits = {
    fileSize: 10 * 1024 * 1024, // 10MB max
    files: 5 // M√°ximo 5 arquivos por vez
};

const fileFilter = (req, file, cb) => {
    const extension = path.extname(file.originalname).toLowerCase();
    
    // Verificar MIME type vs extens√£o
    const mimeExtensions = {
        'image/jpeg': ['.jpg', '.jpeg'],
        'image/png': ['.png'],
        'image/gif': ['.gif'],
        'application/pdf': ['.pdf']
    };
    
    const allowedMimes = mimeExtensions[file.mimetype];
    if (!allowedMimes || !allowedMimes.includes(extension)) {
        logger.security('MIME type mismatch detected', {
            originalName: file.originalname,
            mimetype: file.mimetype,
            extension,
            ip: req.ip
        });
        return cb(new Error('File type mismatch'));
    }
    
    cb(null, true);
};

const secureUpload = multer({
    storage: secureStorage,
    limits: uploadLimits,
    fileFilter
});
```

#### **‚ùå ANTI-PATTERNS MORTAIS:**
```javascript
// ‚ùå MORTE CERTA: readFile sem valida√ß√£o
const userPath = req.body.filePath;
fs.readFile(userPath, callback); // Path traversal vulnerability!

// ‚ùå MORTE CERTA: require din√¢mico
const moduleName = req.query.module;
const module = require(moduleName); // RCE vulnerability!

// ‚ùå MORTE CERTA: Path concatena√ß√£o sem valida√ß√£o
const filePath = './uploads/' + req.params.filename; // Directory traversal!

// ‚ùå MORTE CERTA: Upload sem valida√ß√£o
app.post('/upload', upload.single('file'), (req, res) => {
    // Sem valida√ß√£o = shell upload poss√≠vel
});
```

---

## üåê **WEB & API SECURITY** <a name="web--api-security"></a>

### **üõ°Ô∏è HTTPS & HEADERS SECURITY DEFINITIVA**

#### **‚úÖ SECURITY HEADERS OBRIGAT√ìRIOS:**
```javascript
const helmet = require('helmet');
const express = require('express');

// ‚úÖ HELMET CONFIGURATION DEFINITIVA
const helmetConfig = {
    // Content Security Policy
    contentSecurityPolicy: {
        directives: {
            defaultSrc: ["'self'"],
            scriptSrc: [
                "'self'",
                "'unsafe-inline'", // S√≥ se absolutamente necess√°rio
                "https://cdn.jsdelivr.net",
                "https://unpkg.com"
            ],
            styleSrc: [
                "'self'",
                "'unsafe-inline'",
                "https://fonts.googleapis.com"
            ],
            imgSrc: [
                "'self'",
                "data:",
                "https:"
            ],
            connectSrc: [
                "'self'",
                "https://api.yourservice.com"
            ],
            fontSrc: [
                "'self'",
                "https://fonts.gstatic.com"
            ],
            objectSrc: ["'none'"],
            mediaSrc: ["'self'"],
            frameSrc: ["'none'"],
            upgradeInsecureRequests: []
        }
    },
    
    // HTTP Strict Transport Security
    hsts: {
        maxAge: 31536000, // 1 ano
        includeSubDomains: true,
        preload: true
    },
    
    // X-Frame-Options
    frameguard: { action: 'deny' },
    
    // X-Content-Type-Options
    noSniff: true,
    
    // Referrer Policy
    referrerPolicy: { policy: "strict-origin-when-cross-origin" },
    
    // Remove X-Powered-By
    hidePoweredBy: true
};

// ‚úÖ MIDDLEWARE DEFINITIVO de security headers
const securityHeaders = (req, res, next) => {
    // Security headers b√°sicos
    res.setHeader('X-XSS-Protection', '1; mode=block');
    res.setHeader('X-Frame-Options', 'DENY');
    res.setHeader('X-Content-Type-Options', 'nosniff');
    res.setHeader('Referrer-Policy', 'strict-origin-when-cross-origin');
    res.setHeader('Permissions-Policy', 'geolocation=(), microphone=(), camera=()');
    
    // HTTPS enforcement
    if (process.env.NODE_ENV === 'production') {
        res.setHeader('Strict-Transport-Security', 'max-age=31536000; includeSubDomains; preload');
    }
    
    // Cache control para rotas sens√≠veis
    if (req.path.includes('/api/') || req.path.includes('/admin/')) {
        res.setHeader('Cache-Control', 'no-store, no-cache, must-revalidate, proxy-revalidate');
        res.setHeader('Pragma', 'no-cache');
        res.setHeader('Expires', '0');
    }
    
    next();
};

app.use(helmet(helmetConfig));
app.use(securityHeaders);
```

#### **‚úÖ CORS SECURITY DEFINITIVA:**
```javascript
const cors = require('cors');

// ‚úÖ CORS CONFIGURATION POR AMBIENTE
const getCorsConfig = () => {
    const corsConfig = {
        credentials: true,
        optionsSuccessStatus: 200,
        methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
        allowedHeaders: [
            'Origin',
            'X-Requested-With',
            'Content-Type',
            'Accept',
            'Authorization',
            'X-CSRF-Token'
        ]
    };
    
    if (process.env.NODE_ENV === 'production') {
        corsConfig.origin = [
            'https://yourdomain.com',
            'https://www.yourdomain.com',
            'https://app.yourdomain.com'
        ];
    } else {
        corsConfig.origin = [
            'http://localhost:3000',
            'http://localhost:3001',
            'http://127.0.0.1:3000'
        ];
    }
    
    return corsConfig;
};

// ‚úÖ CORS com validation
const corsWithValidation = cors({
    ...getCorsConfig(),
    origin: (origin, callback) => {
        const allowedOrigins = getCorsConfig().origin;
        
        // Permitir requests sem origin (mobile apps, etc.)
        if (!origin) return callback(null, true);
        
        if (allowedOrigins.includes(origin)) {
            callback(null, true);
        } else {
            logger.security('CORS violation detected', { origin, ip: req.ip });
            callback(new Error('Not allowed by CORS'));
        }
    }
});

app.use(corsWithValidation);
```

#### **‚úÖ CSRF PROTECTION DEFINITIVA:**
```javascript
const csrf = require('csurf');

// ‚úÖ CSRF CONFIGURATION SEGURA
const csrfProtection = csrf({
    cookie: {
        httpOnly: true,
        secure: process.env.NODE_ENV === 'production',
        sameSite: 'strict',
        maxAge: 3600000 // 1 hora
    },
    ignoreMethods: ['GET', 'HEAD', 'OPTIONS'],
    value: (req) => {
        // Suportar CSRF token em header ou body
        return req.body._csrf ||
               req.query._csrf ||
               req.headers['x-csrf-token'] ||
               req.headers['x-xsrf-token'];
    }
});

// ‚úÖ Endpoint para obter CSRF token
app.get('/api/csrf-token', csrfProtection, (req, res) => {
    res.json({ csrfToken: req.csrfToken() });
});

// ‚úÖ Double Submit Cookie pattern (alternativa)
const doubleSubmitCookie = (req, res, next) => {
    if (req.method === 'GET') return next();
    
    const token = req.headers['x-csrf-token'] || req.body._csrf;
    const cookieToken = req.cookies['csrf-token'];
    
    if (!token || token !== cookieToken) {
        logger.security('CSRF token mismatch', { ip: req.ip });
        return res.status(403).json({ error: 'CSRF token invalid' });
    }
    
    next();
};

---

## üßπ **C√ìDIGO LIMPO & ESTRUTURA**

### **üö® REGRA CR√çTICA: COMPLEXIDADE CICLOM√ÅTICA - ZERO TOLER√ÇNCIA**

#### **‚ö° NUNCA MAIS ERRAR COM REFATORA√á√ÉO DE COMPLEXIDADE:**

**‚ùå ERROS MORTAIS QUE CRIAM NOVOS PROBLEMAS:**

```javascript
// ‚ùå ERRO FATAL: Fun√ß√£o auxiliar com muitas opera√ß√µes ||
const mapDataToForm = (data: any): FormData => ({
  field1: data.field1 || '',     // +1
  field2: data.field2 || '',     // +1  
  field3: data.field3 || '',     // +1
  field4: data.field4 || '',     // +1
  // ... 11 campos com ||         // = 11 + 1 = 12 COMPLEXIDADE!
})

// ‚ùå ERRO FATAL: Fun√ß√£o auxiliar com condi√ß√µes aninhadas
function processData(input: string): string {
  if (input.startsWith('+')) {           // +1
    if (input.includes('351')) {         // +1
      return processPortuguese(input);
    } else if (input.length > 10) {     // +1
      return processInternational(input);
    }
  }
  return input; // TOTAL: 1 + 1 + 1 + 1 = 4 (OK, mas pode crescer!)
}
```

**‚úÖ SOLU√á√ïES BULLETPROOF:**

```javascript
// ‚úÖ SOLU√á√ÉO 1: Fun√ß√£o utilit√°ria simples para m√∫ltiplos campos
const getSafeValue = (data: any, field: string): string => data?.[field] ?? '';

const mapDataToForm = (data: any): FormData => {
  const getValue = (field: string) => getSafeValue(data, field);
  
  return {
    field1: getValue('field1'),
    field2: getValue('field2'),
    field3: getValue('field3'),
    // ... sem operadores condicionais = COMPLEXIDADE 1!
  };
};

// ‚úÖ SOLU√á√ÉO 2: Mapa de configura√ß√£o para eliminar condi√ß√µes
const PHONE_PROCESSORS = {
  '+351': processPortuguese,
  'international': processInternational,
  'default': processDefault
};

function processData(input: string): string {
  const processor = input.startsWith('+351') ? PHONE_PROCESSORS['+351'] :
                   input.length > 10 ? PHONE_PROCESSORS['international'] :
                   PHONE_PROCESSORS['default'];
  
  return processor(input); // COMPLEXIDADE: 1 (operador tern√°rio conta como 1 total)
}
```

#### **üîç CHECKLIST OBRIGAT√ìRIO ANTES DE CADA REFATORA√á√ÉO:**

**ANTES DE REFATORAR:**
1. ‚úÖ **Contar operadores na fun√ß√£o original**: `if`, `&&`, `||`, `?:`, `case`, `catch`
2. ‚úÖ **Identificar o n√∫mero exato de condi√ß√µes**
3. ‚úÖ **Planejar divis√£o SEM criar novas condi√ß√µes**

**DURANTE A REFATORA√á√ÉO:**
4. ‚úÖ **Cada fun√ß√£o auxiliar = M√ÅXIMO 3 condi√ß√µes**
5. ‚úÖ **Preferir mapas/objetos a m√∫ltiplos `if/else`**
6. ‚úÖ **Evitar operadores `||` em massa**
7. ‚úÖ **Uma responsabilidade = uma fun√ß√£o**

**AP√ìS A REFATORA√á√ÉO:**
8. ‚úÖ **Contar complexidade de CADA fun√ß√£o auxiliar criada**
9. ‚úÖ **Verificar se soma total < complexidade original**
10. ‚úÖ **Testar que funcionalidade n√£o quebrou**

#### **üìä F√ìRMULA DE COMPLEXIDADE CICLOM√ÅTICA:**
```
COMPLEXIDADE = 1 (base) + n√∫mero de:
- if statements
- else if statements  
- while/for loops
- && operators
- || operators
- ?: ternary operators
- catch blocks
- case statements
- && em conditions
- || em conditions
```

#### **üéØ ESTRAT√âGIAS ANTI-COMPLEXIDADE:**

**ESTRAT√âGIA 1: Mapa de Fun√ß√µes**
```javascript
// ‚ùå Complexidade alta
function handleAction(type: string) {
  if (type === 'create') return createHandler();
  if (type === 'update') return updateHandler();  
  if (type === 'delete') return deleteHandler();
  // ... +3 complexidade
}

// ‚úÖ Complexidade 1
const ACTION_HANDLERS = {
  create: createHandler,
  update: updateHandler,
  delete: deleteHandler
};

function handleAction(type: string) {
  return ACTION_HANDLERS[type]?.() || defaultHandler();
}
```

**ESTRAT√âGIA 2: Early Returns**
```javascript
// ‚ùå Condi√ß√µes aninhadas
function validate(data: any) {
  if (data) {
    if (data.email) {
      if (data.email.includes('@')) {
        return true;
      }
    }
  }
  return false;
}

// ‚úÖ Early returns
function validate(data: any) {
  if (!data) return false;
  if (!data.email) return false;
  if (!data.email.includes('@')) return false;
  return true;
}
```

**ESTRAT√âGIA 3: Fun√ß√£o de Configura√ß√£o**
```javascript
// ‚ùå M√∫ltiplas condi√ß√µes
function getConfig(env: string) {
  return {
    apiUrl: env === 'prod' ? 'prod-url' : env === 'staging' ? 'staging-url' : 'dev-url',
    timeout: env === 'prod' ? 5000 : env === 'staging' ? 3000 : 1000,
    // +6 operadores tern√°rios
  };
}

// ‚úÖ Objeto de configura√ß√£o
const ENV_CONFIGS = {
  prod: { apiUrl: 'prod-url', timeout: 5000 },
  staging: { apiUrl: 'staging-url', timeout: 3000 },
  dev: { apiUrl: 'dev-url', timeout: 1000 }
};

function getConfig(env: string) {
  return ENV_CONFIGS[env] || ENV_CONFIGS.dev;
}
```

#### **üö® REGRA DE OURO FINAL:**
**"NUNCA REFATORAR SEM MEDIR A COMPLEXIDADE DE CADA FUN√á√ÉO AUXILIAR CRIADA"**

#### **üí° FERRAMENTAS PARA MEDIR COMPLEXIDADE:**
- **Manual**: Contar cada `if`, `&&`, `||`, `?:`, `case`, `catch`
- **ESLint**: `complexity` rule com limite 8
- **SonarQube/Codacy**: An√°lise autom√°tica
- **VS Code**: Extens√µes como "CodeMetrics"

---

## üõ°Ô∏è **ULTRA PROMPT: COMPLEXIDADE CICLOM√ÅTICA - ZERO ERROS GARANTIDOS**
### **PROMPT DEFINITIVO PARA REDU√á√ÉO DE COMPLEXIDADE COM MCP CONTEXT**

#### **üéØ OBJETIVO ABSOLUTO**
**NUNCA MAIS aumentar complexidade ciclom√°tica. SEMPRE diminuir. ZERO toler√¢ncia para erros.**

#### **üö® REGRAS ABSOLUTAS - NUNCA VIOLAR**

##### **‚ö° REGRA DE OURO:**
```
ANTES de qualquer refatora√ß√£o:
1. CONTAR complexidade da fun√ß√£o original
2. PLANEJAR redu√ß√£o SEM criar novas condi√ß√µes
3. MEDIR complexidade de CADA fun√ß√£o auxiliar criada
4. VERIFICAR que soma total < original
5. TESTAR que funcionalidade n√£o quebrou
```

##### **üìä F√ìRMULA MATEM√ÅTICA OBRIGAT√ìRIA:**
```
COMPLEXIDADE = 1 (base) + SOMA de:
- if/else if statements
- while/for loops  
- && operators
- || operators
- ?: ternary operators
- catch blocks
- case statements em switch
- Cada condi√ß√£o em express√µes booleanas
```

#### **üî• ESTRAT√âGIAS ANTI-COMPLEXIDADE BULLETPROOF**

##### **ESTRAT√âGIA 1: MAPA DE CONFIGURA√á√ÉO**
```javascript
// ‚ùå COMPLEXIDADE ALTA (7 pontos)
function getRedirectUrl(role: string, metadata: any): string {
  if (role === 'admin') return '/admin';
  if (role === 'user') return '/user';
  if (role === 'guest') return '/guest';
  if (metadata && metadata.premium) return '/premium';
  return '/default';
}

// ‚úÖ COMPLEXIDADE 1
const ROLE_REDIRECTS = {
  admin: '/admin',
  user: '/user', 
  guest: '/guest'
};

function getRedirectUrl(role: string, metadata: any): string {
  if (metadata?.premium) return '/premium';
  return ROLE_REDIRECTS[role] || '/default';
}
```

##### **ESTRAT√âGIA 2: EARLY RETURNS**
```javascript
// ‚ùå COMPLEXIDADE ALTA (aninhamento)
function validateUser(user: any): boolean {
  if (user) {
    if (user.email) {
      if (user.email.includes('@')) {
        if (user.password) {
          if (user.password.length >= 8) {
            return true;
          }
        }
      }
    }
  }
  return false;
}

// ‚úÖ COMPLEXIDADE 5 (linear)
function validateUser(user: any): boolean {
  if (!user) return false;
  if (!user.email) return false;
  if (!user.email.includes('@')) return false;
  if (!user.password) return false;
  if (user.password.length < 8) return false;
  return true;
}
```

##### **ESTRAT√âGIA 3: FUN√á√ÉO UTILIT√ÅRIA PARA M√öLTIPLOS CAMPOS**
```javascript
// ‚ùå COMPLEXIDADE MORTAL (12+ pontos)
const mapFormData = (data: any) => ({
  field1: data.field1 || '',     // +1
  field2: data.field2 || '',     // +1
  field3: data.field3 || '',     // +1
  field4: data.field4 || '',     // +1
  // ... 10 campos = 10+ complexidade!
});

// ‚úÖ COMPLEXIDADE 1
const getSafeValue = (data: any, field: string): string => data?.[field] ?? '';

const mapFormData = (data: any) => {
  const getValue = (field: string) => getSafeValue(data, field);
  return {
    field1: getValue('field1'),
    field2: getValue('field2'),
    field3: getValue('field3'),
    // ... sem operadores condicionais!
  };
};
```

##### **ESTRAT√âGIA 4: PATTERN MATCHING COM OBJETOS**
```javascript
// ‚ùå COMPLEXIDADE ALTA
function processAction(type: string, data: any) {
  if (type === 'CREATE' && data.valid) return createHandler(data);
  if (type === 'UPDATE' && data.valid) return updateHandler(data);
  if (type === 'DELETE' && data.valid) return deleteHandler(data);
  if (type === 'VALIDATE') return validateHandler(data);
  return errorHandler();
}

// ‚úÖ COMPLEXIDADE 2
const ACTION_PROCESSORS = {
  CREATE: (data: any) => data.valid ? createHandler(data) : errorHandler(),
  UPDATE: (data: any) => data.valid ? updateHandler(data) : errorHandler(), 
  DELETE: (data: any) => data.valid ? deleteHandler(data) : errorHandler(),
  VALIDATE: validateHandler
};

function processAction(type: string, data: any) {
  const processor = ACTION_PROCESSORS[type];
  return processor ? processor(data) : errorHandler();
}
```

#### **üîç CHECKLIST PR√â-REFATORA√á√ÉO OBRIGAT√ìRIO**

##### **üìã ANTES DE TOCAR NO C√ìDIGO:**
```
‚ñ° Li a fun√ß√£o original completamente
‚ñ° Contei EXATAMENTE quantos if/else/&&/||/?:/case existem
‚ñ° Calculei complexidade original (base 1 + operadores)
‚ñ° Identifiquei responsabilidades da fun√ß√£o
‚ñ° Planejei divis√£o SEM criar condi√ß√µes extras
‚ñ° Defini estrat√©gia (mapa, early returns, utilit√°ria)
```

##### **‚ö° DURANTE A REFATORA√á√ÉO:**
```
‚ñ° Cada fun√ß√£o auxiliar tem M√ÅXIMO 3 condi√ß√µes
‚ñ° Usei mapas/objetos em vez de m√∫ltiplos if/else
‚ñ° Evitei operadores || em massa
‚ñ° Apliquei early returns para reduzir aninhamento
‚ñ° Uma responsabilidade = uma fun√ß√£o
‚ñ° Nomes descritivos para cada fun√ß√£o auxiliar
```

##### **‚úÖ AP√ìS REFATORA√á√ÉO:**
```
‚ñ° Contei complexidade de CADA fun√ß√£o auxiliar criada
‚ñ° Somei complexidades: original vs (principal + auxiliares)
‚ñ° Confirmei que TOTAL < ORIGINAL
‚ñ° Testei que funcionalidade n√£o quebrou
‚ñ° Verificei linting sem erros
‚ñ° Executei build com sucesso
```

#### **üéØ ESTRAT√âGIAS POR TIPO DE FUN√á√ÉO**

##### **TIPO 1: VALIDA√á√ÉO/PARSING**
```javascript
// Use: Early Returns + Fun√ß√£o Utilit√°ria
function parseData(input: string): ParsedData | null {
  if (!input) return null;
  if (input.length < 5) return null;
  if (!input.includes('@')) return null;
  
  const parts = input.split('@');
  return createParsedData(parts);
}
```

##### **TIPO 2: MAPEAMENTO DE DADOS**
```javascript
// Use: Fun√ß√£o Utilit√°ria + Objeto de Configura√ß√£o
const FIELD_MAPPINGS = {
  name: 'full_name',
  email: 'email_address',
  phone: 'phone_number'
};

function mapUserData(source: any): UserData {
  const getValue = (sourceField: string, targetField: string) => 
    source[sourceField] ?? getDefaultValue(targetField);
    
  return Object.entries(FIELD_MAPPINGS).reduce((acc, [src, target]) => ({
    ...acc,
    [target]: getValue(src, target)
  }), {} as UserData);
}
```

##### **TIPO 3: PROCESSAMENTO CONDICIONAL**
```javascript
// Use: Mapa de Processadores
const DATA_PROCESSORS = {
  user: processUserData,
  admin: processAdminData,
  guest: processGuestData
};

function processData(type: string, data: any) {
  const processor = DATA_PROCESSORS[type] || DATA_PROCESSORS.guest;
  return processor(data);
}
```

##### **TIPO 4: CONFIGURA√á√ÉO/SETUP**
```javascript
// Use: Objeto de Configura√ß√£o + Factory Pattern
const CONFIG_BUILDERS = {
  development: () => ({ debug: true, timeout: 1000 }),
  production: () => ({ debug: false, timeout: 5000 }),
  test: () => ({ debug: true, timeout: 500 })
};

function buildConfig(env: string) {
  const builder = CONFIG_BUILDERS[env] || CONFIG_BUILDERS.development;
  return builder();
}
```

#### **üõ†Ô∏è FERRAMENTAS DE MEDI√á√ÉO**

##### **MANUAL (OBRIGAT√ìRIO):**
```javascript
// Contar manualmente:
function example(a: string, b: number): string {
  // Base: 1
  if (a.length > 0) {           // +1 = 2
    if (b > 10 && b < 100) {    // +2 (if + &&) = 4
      return a.toUpperCase();
    } else if (b === 0) {       // +1 = 5
      return a.toLowerCase();
    }
  }
  return a || 'default';        // +1 (||) = 6
}
// TOTAL: 6 pontos de complexidade
```

##### **AUTOM√ÅTICO:**
```json
// .eslintrc.json
{
  "rules": {
    "complexity": ["error", { "max": 8 }]
  }
}
```

#### **üö® ANTI-PATTERNS MORTAIS - NUNCA FAZER**

##### **‚ùå MORTE INSTANT√ÇNEA 1: || EM MASSA**
```javascript
// ‚ùå COMPLEXIDADE 12+
const data = {
  a: input.a || '',
  b: input.b || '',
  c: input.c || '',
  // ... cada || = +1 complexidade
};
```

##### **‚ùå MORTE INSTANT√ÇNEA 2: CONDI√á√ïES ANINHADAS**
```javascript
// ‚ùå COMPLEXIDADE EXPONENCIAL
if (user) {
  if (user.role) {
    if (user.role === 'admin') {
      if (user.permissions) {
        if (user.permissions.includes('write')) {
          // ...
        }
      }
    }
  }
}
```

##### **‚ùå MORTE INSTANT√ÇNEA 3: SWITCH GIGANTE**
```javascript
// ‚ùå COMPLEXIDADE = casos + nested ifs
switch (type) {
  case 'A':
    if (data.valid) return processA(data);
    break;
  case 'B':
    if (data.valid && data.premium) return processB(data);
    break;
  // ... cada case + if = +2 complexidade
}
```

#### **üéØ METAS DE REDU√á√ÉO POR COMPLEXIDADE ORIGINAL**

##### **COMPLEXIDADE 8-12 (Baixo Risco):**
```
Meta: Reduzir para 3-5
Estrat√©gia: Early Returns + 1 fun√ß√£o auxiliar
Tempo: 5-10 minutos
```

##### **COMPLEXIDADE 13-20 (M√©dio Risco):**
```
Meta: Reduzir para 4-6
Estrat√©gia: Mapa + 2-3 fun√ß√µes auxiliares
Tempo: 15-20 minutos
```

##### **COMPLEXIDADE 21+ (Alto Risco):**
```
Meta: Reduzir para 5-7
Estrat√©gia: M√∫ltiplas estrat√©gias + 4+ fun√ß√µes auxiliares
Tempo: 30+ minutos
```

#### **üìä TRACKING DE PROGRESSO**

##### **TEMPLATE DE REFATORA√á√ÉO:**
```markdown
## REFATORA√á√ÉO: [nome_da_fun√ß√£o]

### ANTES:
- Complexidade Original: X
- N√∫mero de condi√ß√µes: Y
- Responsabilidades: [listar]

### ESTRAT√âGIA:
- [Early Returns / Mapa / Utilit√°ria / etc.]

### FUN√á√ïES AUXILIARES CRIADAS:
1. funcao1(): Complexidade Z1
2. funcao2(): Complexidade Z2

### DEPOIS:
- Complexidade Principal: A
- Complexidade Total: A + Z1 + Z2 = TOTAL
- Redu√ß√£o: X - TOTAL = MELHORIA
- ‚úÖ Funcionalidade preservada
- ‚úÖ Testes passaram
```

#### **üî• ULTRA PROMPT PARA IA/ASSISTANT**

```
CONTEXTO: Sou um assistant que NUNCA MAIS pode aumentar complexidade ciclom√°tica.

REGRAS ABSOLUTAS:
1. SEMPRE contar complexidade original antes de refatorar
2. SEMPRE usar estrat√©gias anti-complexidade (mapas, early returns, utilit√°rias)
3. SEMPRE medir complexidade de cada fun√ß√£o auxiliar criada
4. SEMPRE verificar que soma total < original
5. NUNCA usar || em massa ou condi√ß√µes aninhadas

ESTRAT√âGIAS OBRIGAT√ìRIAS:
- Complexidade 8-12: Early Returns + 1 auxiliar
- Complexidade 13-20: Mapa + 2-3 auxiliares  
- Complexidade 21+: M√∫ltiplas estrat√©gias + 4+ auxiliares

VERIFICA√á√ÉO FINAL:
- Contar: Original X vs Total Y
- Confirmar: Y < X (redu√ß√£o obrigat√≥ria)
- Testar: Funcionalidade preservada

SE N√ÉO CONSEGUIR REDUZIR: Parar e pedir ajuda em vez de piorar.
```

#### **üõ°Ô∏è GARANTIA DE QUALIDADE**

##### **ANTES DE COMMIT:**
```bash
# 1. Verificar complexidade
npm run lint

# 2. Verificar build
npm run build

# 3. Verificar testes
npm test

# 4. Commit apenas se TUDO passou
git commit -m "refactor: reduce complexity [fun√ß√£o] (X‚ÜíY points)"
```

##### **AP√ìS COMMIT:**
```
‚ñ° Codacy mostra redu√ß√£o de complexidade
‚ñ° Nenhum novo erro introduzido
‚ñ° Quality gate melhorou ou manteve
‚ñ° Issues count diminuiu
```

#### **üéØ RESULTADO FINAL GARANTIDO**

**COM ESTE ULTRA PROMPT:**
- ‚úÖ Complexidade SEMPRE diminui
- ‚úÖ ZERO novos erros criados
- ‚úÖ Qualidade do c√≥digo melhora
- ‚úÖ Funcionalidade preservada
- ‚úÖ Codacy Quality Gate passa

**SEM ESTE PROMPT:**
- ‚ùå Complexidade pode aumentar
- ‚ùå Novos erros s√£o criados
- ‚ùå Qualidade degrada
- ‚ùå Quality Gate falha
- ‚ùå Technical debt aumenta

---

## üö® **REGRAS ABSOLUTAS PARA AGENTS/IA - NUNCA VIOLAR**

### **‚ö° REGRA DE OURO PARA AGENTS:**
```
ANTES de qualquer refatora√ß√£o de complexidade:
1. LER completamente o @regrascodacy.md
2. APLICAR a f√≥rmula matem√°tica em CADA fun√ß√£o auxiliar
3. CONTAR manualmente cada if, &&, ||, ?:, case, catch
4. VERIFICAR que SOMA TOTAL < ORIGINAL
5. SE n√£o conseguir reduzir: PARAR e pedir ajuda
```

### **üî¢ F√ìRMULA OBRIGAT√ìRIA PARA AGENTS:**
```
PARA CADA FUN√á√ÉO AUXILIAR CRIADA:
COMPLEXIDADE = 1 (base) + CONTAR:
- if statements (cada if = +1)
- else if statements (cada else if = +1)
- && operators (cada && = +1)
- || operators (cada || = +1)
- ?: ternary operators (cada tern√°rio = +1)
- typeof checks (cada typeof = +1)
- !== comparisons (cada !== = +1)
- === comparisons (cada === = +1)
- > < >= <= comparisons (cada = +1)
- case statements (cada case = +1)
- catch blocks (cada catch = +1)
- early returns com condi√ß√£o (cada return com if = +1)
```

### **‚ùå ERROS MORTAIS QUE AGENTS COMETEM:**
```
‚ùå ERRO FATAL 1: "Early returns s√£o sempre simples"
   REALIDADE: if + return = 2 pontos CADA UM!
   
‚ùå ERRO FATAL 2: "Dividir fun√ß√£o = reduzir complexidade"  
   REALIDADE: 1 fun√ß√£o (20 pontos) ‚Üí 4 fun√ß√µes (8+7+6+5 = 26 pontos) = PIOR!
   
‚ùå ERRO FATAL 3: "Valida√ß√µes s√£o simples"
   REALIDADE: typeof + !== + && = 3+ pontos CADA valida√ß√£o!
   
‚ùå ERRO FATAL 4: "N√£o preciso medir fun√ß√µes auxiliares"
   REALIDADE: CADA fun√ß√£o auxiliar DEVE ser medida!
```

### **‚úÖ ESTRAT√âGIAS CORRETAS PARA AGENTS:**
```
‚úÖ ESTRAT√âGIA 1: MAPA DE CONFIGURA√á√ÉO (Complexidade: 1)
const VALIDATORS = {
  string: (val) => typeof val === 'string',
  number: (val) => typeof val === 'number',
  email: (val) => /\S+@\S+\.\S+/.test(val)
};

‚úÖ ESTRAT√âGIA 2: ARRAY.EVERY/SOME (Complexidade: 1-2)
const isValid = REQUIRED_FIELDS.every(field => data[field]);

‚úÖ ESTRAT√âGIA 3: FUN√á√ÉO UTILIT√ÅRIA REUTILIZ√ÅVEL (Complexidade: 1)
const getSafeValue = (obj, key) => obj?.[key] ?? '';
```

### **üîç CHECKLIST OBRIGAT√ìRIO PARA AGENTS:**
```
ANTES DE CRIAR FUN√á√ÉO AUXILIAR:
‚ñ° Contei quantos if/else/&&/||/?:/case vou usar?
‚ñ° Apliquei a f√≥rmula matem√°tica?
‚ñ° Complexidade vai ser ‚â§ 3 pontos?
‚ñ° Posso usar mapa/configura√ß√£o em vez de condi√ß√µes?

DEPOIS DE CRIAR FUN√á√ÉO AUXILIAR:
‚ñ° Contei a complexidade real da fun√ß√£o criada?
‚ñ° Somei: Original vs (Principal + Todas Auxiliares)?
‚ñ° Confirmei que TOTAL < ORIGINAL?
‚ñ° Se n√£o consegui reduzir: PAREI e pedi ajuda?
```

### **üìä TEMPLATE DE VERIFICA√á√ÉO PARA AGENTS:**
```markdown
## REFATORA√á√ÉO: [nome_da_fun√ß√£o]

### ANTES:
- Complexidade Original: X pontos
- N√∫mero de condi√ß√µes: Y

### FUN√á√ïES AUXILIARES CRIADAS:
1. funcao1(): CONTEI X pontos (if=?, &&=?, ||=?, etc.)
2. funcao2(): CONTEI Y pontos (if=?, &&=?, ||=?, etc.)
3. funcao3(): CONTEI Z pontos (if=?, &&=?, ||=?, etc.)

### VERIFICA√á√ÉO MATEM√ÅTICA:
- Complexidade Original: X
- Complexidade Nova: A + Y + Z = TOTAL
- Redu√ß√£o: X - TOTAL = ? (DEVE SER POSITIVO!)

### RESULTADO:
‚ñ° TOTAL < ORIGINAL? (SIM/N√ÉO)
‚ñ° Se N√ÉO: PARAR e usar estrat√©gia diferente
‚ñ° Se SIM: Prosseguir com confian√ßa
```

### **üö® REGRA FINAL PARA AGENTS:**
```
SE AP√ìS REFATORA√á√ÉO:
- Codacy mostrar NOVOS erros de complexidade
- Issues count AUMENTAR em vez de diminuir
- Aparecerem erros em fun√ß√µes que criei

ENT√ÉO:
- EU VIOLEI as regras do @regrascodacy.md
- DEVO admitir o erro imediatamente
- DEVO aprender com o erro
- DEVO aplicar as estrat√©gias corretas
```

---

## üö® **SISTEMA ANTI-FALHA DEFINITIVO - ZERO ERROS GARANTIDOS**
### **CHECKLIST OBRIGAT√ìRIO PARA AGENTS/IA - NUNCA PULAR**

#### **‚ö° ANTES DE QUALQUER REFATORA√á√ÉO:**

```markdown
## ‚úÖ PASSO 1: INVENT√ÅRIO COMPLETO
‚ñ° Listo TODOS os arquivos que vou modificar
‚ñ° Listo TODOS os arquivos novos que vou criar  
‚ñ° Leio COMPLETAMENTE cada arquivo
‚ñ° Identifico TODAS as fun√ß√µes que ser√£o alteradas

## ‚úÖ PASSO 2: CONTAGEM MANUAL OBRIGAT√ìRIA
Para CADA fun√ß√£o (nova ou modificada):
‚ñ° Conto MANUALMENTE: if, else if, &&, ||, ?:, catch, case, typeof
‚ñ° Escrevo a f√≥rmula: 1 + X + Y + Z = TOTAL
‚ñ° Verifico se TOTAL ‚â§ 8
‚ñ° Se > 8: PARO e aplico estrat√©gias anti-complexidade

## ‚úÖ PASSO 3: ESTRAT√âGIA POR COMPLEXIDADE
‚ñ° Se 1-8: OK, prosseguir
‚ñ° Se 9-15: Aplicar 1 estrat√©gia (mapa OU early returns)  
‚ñ° Se 16+: Aplicar m√∫ltiplas estrat√©gias obrigatoriamente

## ‚úÖ PASSO 4: VERIFICA√á√ÉO MATEM√ÅTICA
‚ñ° Complexidade Original: X pontos
‚ñ° Complexidade Nova: A + B + C = TOTAL
‚ñ° Confirmo que TOTAL < X (OBRIGAT√ìRIO)
‚ñ° Se TOTAL ‚â• X: PARO e uso estrat√©gia diferente

## ‚úÖ PASSO 5: TESTE ANTES DE COMMIT
‚ñ° npm run build (sem erros)
‚ñ° Verifico se h√° novos erros no linter
‚ñ° Se h√° NOVOS erros: PARO e corrijo IMEDIATAMENTE
‚ñ° Testo funcionalidade n√£o quebrou
```

#### **üìä TEMPLATE DE AN√ÅLISE OBRIGAT√ìRIO:**

```markdown
## AN√ÅLISE DE COMPLEXIDADE: [nome_fun√ß√£o]

### CONTAGEM MANUAL:
```javascript
function exemplo() {
  if (a?.b) {           // +2 (if + ?.)
    return b || c;      // +1 (||)
  }
  try {                 // +1 (try/catch)
    // code
  } catch (e) {         // +1 (catch expl√≠cito)
    // error
  }
}
// BASE: 1
// TOTAL: 1 + 2 + 1 + 1 + 1 = 6 pontos
```

### ESTRAT√âGIA APLICADA:
- [x] Mapa de configura√ß√£o
- [ ] Early returns
- [ ] Fun√ß√£o utilit√°ria
- [ ] Divis√£o por responsabilidade

### VERIFICA√á√ÉO FINAL:
- Complexidade Original: X
- Complexidade Nova: Y  
- Redu√ß√£o: X - Y = Z (DEVE SER POSITIVO)
- ‚úÖ Build sem erros
- ‚úÖ Funcionalidade preservada
```

#### **üî• F√ìRMULA EXPANDIDA DE COMPLEXIDADE:**

```
COMPLEXIDADE = 1 (base) + SOMA de:
- if statements (+1 cada)
- else if statements (+1 cada)  
- while/for loops (+1 cada)
- && operators (+1 cada)
- || operators (+1 cada)
- ?. optional chaining (+1 cada)
- ?: ternary operators (+1 cada)
- catch blocks (+1 cada)
- case statements (+1 cada)
- typeof checks (+1 cada)
- !== comparisons (+1 cada)
- === comparisons (+1 cada)
- > < >= <= comparisons (+1 cada)
- early returns com condi√ß√£o (+1 cada)
```

#### **üõ°Ô∏è ESTRAT√âGIAS ANTI-COMPLEXIDADE AVAN√áADAS:**

##### **ESTRAT√âGIA 1: MAPA DE VALIDADORES**
```javascript
// ‚ùå Complexidade 8+
function validate(data) {
  if (!data.email) return false;
  if (!data.email.includes('@')) return false;
  if (!data.password) return false;
  if (data.password.length < 8) return false;
  if (!/[A-Z]/.test(data.password)) return false;
  return true;
}

// ‚úÖ Complexidade 2
const VALIDATORS = {
  email: (val) => val && val.includes('@'),
  password: (val) => val && val.length >= 8 && /[A-Z]/.test(val)
};

function validate(data) {
  const failures = Object.entries(VALIDATORS)
    .filter(([key, validator]) => !validator(data[key]));
  return failures.length === 0;
}
```

##### **ESTRAT√âGIA 2: CONFIGURATION-DRIVEN LOGIC**
```javascript
// ‚ùå Complexidade 10+
function processUser(user, type) {
  if (type === 'admin') {
    if (user.permissions.includes('write')) {
      return processAdminWrite(user);
    } else if (user.permissions.includes('read')) {
      return processAdminRead(user);
    }
  } else if (type === 'user') {
    if (user.verified) {
      return processVerifiedUser(user);
    } else {
      return processUnverifiedUser(user);
    }
  }
  return processGuest(user);
}

// ‚úÖ Complexidade 3
const USER_PROCESSORS = {
  admin: {
    write: processAdminWrite,
    read: processAdminRead,
    default: processAdminRead
  },
  user: {
    verified: processVerifiedUser,
    unverified: processUnverifiedUser,
    default: (user) => user.verified ? processVerifiedUser(user) : processUnverifiedUser(user)
  },
  default: processGuest
};

function processUser(user, type) {
  const typeProcessors = USER_PROCESSORS[type] || USER_PROCESSORS.default;
  if (typeof typeProcessors === 'function') return typeProcessors(user);
  
  const permission = user.permissions?.[0] || 'default';
  const processor = typeProcessors[permission] || typeProcessors.default;
  return processor(user);
}
```

##### **ESTRAT√âGIA 3: PIPELINE PATTERN**
```javascript
// ‚ùå Complexidade 12+
function processData(input) {
  if (!input) throw new Error('No input');
  if (typeof input !== 'string') throw new Error('Invalid type');
  if (input.length < 5) throw new Error('Too short');
  if (!input.includes('@')) throw new Error('No @');
  
  const cleaned = input.trim().toLowerCase();
  const parts = cleaned.split('@');
  if (parts.length !== 2) throw new Error('Invalid format');
  if (parts[0].length < 3) throw new Error('Username too short');
  if (!parts[1].includes('.')) throw new Error('Invalid domain');
  
  return { username: parts[0], domain: parts[1] };
}

// ‚úÖ Complexidade 2
const VALIDATION_PIPELINE = [
  (input) => input || (() => { throw new Error('No input'); })(),
  (input) => typeof input === 'string' || (() => { throw new Error('Invalid type'); })(),
  (input) => input.length >= 5 || (() => { throw new Error('Too short'); })(),
  (input) => input.includes('@') || (() => { throw new Error('No @'); })()
];

const PROCESSING_PIPELINE = [
  (input) => input.trim().toLowerCase(),
  (input) => input.split('@'),
  (parts) => parts.length === 2 ? parts : (() => { throw new Error('Invalid format'); })(),
  (parts) => parts[0].length >= 3 ? parts : (() => { throw new Error('Username too short'); })(),
  (parts) => parts[1].includes('.') ? parts : (() => { throw new Error('Invalid domain'); })(),
  (parts) => ({ username: parts[0], domain: parts[1] })
];

function processData(input) {
  VALIDATION_PIPELINE.forEach(validator => validator(input));
  return PROCESSING_PIPELINE.reduce((acc, processor) => processor(acc), input);
}
```

#### **üö® REGRAS DE OURO FINAIS:**

1. **NUNCA assumir que "early returns s√£o simples"** - CADA if + return = +2 pontos
2. **NUNCA criar fun√ß√£o auxiliar sem medir sua complexidade primeiro**
3. **SEMPRE somar complexidade total (principal + todas auxiliares)**
4. **SE n√£o conseguir reduzir: PARAR e pedir ajuda**
5. **SEMPRE testar que funcionalidade n√£o quebrou**

#### **üîß COMPROMISSO DO AGENT:**
```
PROMETO que daqui para frente:
1. ‚úÖ SEMPRE usar este checklist obrigat√≥rio
2. ‚úÖ SEMPRE contar manualmente cada operador
3. ‚úÖ SEMPRE verificar TODOS os arquivos (novos e modificados)
4. ‚úÖ SEMPRE testar antes de commit
5. ‚úÖ SE violar: admitir imediatamente e corrigir
6. ‚úÖ NUNCA fazer push se houver novos erros no Codacy
```

---

**üî• USE ESTE SISTEMA SEMPRE ANTES DE REFATORAR QUALQUER FUN√á√ÉO! üî•**

------
# üîç AUDITORIA COMPLETA DE PROJETO - MIGUEL LOPES
## An√°lise Ultra-Detalhada de Website/Aplica√ß√£o

---

## üéØ CONTEXTO E OBJETIVO
Voc√™ √© um **Senior Software Architect** e **Security Specialist** contratado para fazer a auditoria mais completa poss√≠vel do projeto do Miguel Lopes. Esta an√°lise deve ser **EXTREMAMENTE DETALHADA** e cobrir TODOS os aspectos t√©cnicos, de seguran√ßa, performance e arquitetura.

### üìã ENTREG√ÅVEL FINAL
Criar um documento completo chamado **"AUDITORIA_COMPLETA_MIGUELLOPES.md"** com an√°lise minuciosa de cada arquivo, fun√ß√£o, componente e linha de c√≥digo relevante.

---

## üî• METODOLOGIA ULTRA-DETALHADA

### üõ°Ô∏è FASE 1: AUDITORIA DE SEGURAN√áA EXTREMA

#### 1.1 An√°lise de Logs e Exposi√ß√£o de Dados
**Procure METICULOSAMENTE por:**
- `console.log()`, `console.error()`, `console.warn()`, `console.info()`, `console.debug()`
- `alert()`, `confirm()`, `prompt()` com dados sens√≠veis
- `localStorage.setItem()`, `sessionStorage.setItem()` com dados cr√≠ticos
- Cookies com informa√ß√µes sens√≠veis
- Headers HTTP expostos
- Tokens JWT decodificados no frontend
- Passwords em plaintext
- API keys hardcoded
- Database connection strings
- Email addresses e dados pessoais
- N√∫meros de telefone e dados RGPD
- Chaves de encripta√ß√£o
- Dados de cart√£o de cr√©dito
- Informa√ß√µes de sess√£o ativas

**Para cada ocorr√™ncia encontrada:**
```
üö® VAZAMENTO DE DADOS CR√çTICO
üìÅ Arquivo: /caminho/exato/arquivo.js
üìç Linha: 123
üíÄ Tipo: Password em plaintext
üîç C√≥digo: console.log("User password:", userPassword)
‚ö†Ô∏è Risco: CR√çTICO - Exposi√ß√£o total de credenciais
üí° Solu√ß√£o: Remover imediatamente + implementar logger seguro
üïê Descoberto em: [timestamp]
```

#### 1.2 An√°lise de Autentica√ß√£o e Autoriza√ß√£o
- Verifica√ß√£o de tokens JWT (expira√ß√£o, algoritmos, claims)
- Sistemas de refresh tokens
- Middleware de autentica√ß√£o
- Prote√ß√£o de rotas administrativas
- Valida√ß√£o de permiss√µes por endpoint
- Rate limiting implementado
- Prote√ß√£o contra CSRF
- Valida√ß√£o de CORS
- Headers de seguran√ßa (HSTS, CSP, X-Frame-Options)

#### 1.4 An√°lise de Logs e Sistemas de Monitoriza√ß√£o
**Verificar OBRIGATORIAMENTE:**
- Logs de aplica√ß√£o (Winston, Morgan, etc.)
- Logs de sistema (PM2, Docker, etc.)
- Logs de servidor web (Nginx, Apache)
- Logs de base de dados
- Logs de CDN e proxy
- Error tracking (Sentry, Bugsnag)
- Performance monitoring (New Relic, DataDog)
- User activity logs
- Audit trails de altera√ß√µes cr√≠ticas

#### 1.5 An√°lise de Infraestrutura e Deploy
**Security Infrastructure:**
- Certificados SSL/TLS (validade, configura√ß√£o)
- Firewall rules e network security
- Environment variables exposure
- Container security (Docker, K8s)
- CI/CD pipeline security
- Secrets management
- Backup security e encryption
- Access control (IAM, roles)

#### 1.6 An√°lise de Compliance e Regulamenta√ß√µes
**Verificar conformidade:**
- RGPD/GDPR compliance
- Cookies policy implementation
- Data retention policies
- Right to be forgotten
- Privacy policy adequacy
- Terms of service accuracy
- Age verification systems
- Data processing agreements

### üóÑÔ∏è FASE 2: AN√ÅLISE DE BASE DE DADOS E QUERIES

#### 2.1 Auditoria de Performance de Queries
**Para cada query encontrada:**
```sql
-- Exemplo de an√°lise
SELECT * FROM users WHERE email = ? AND active = 1
```

**An√°lise detalhada:**
```
üîç QUERY ANALYSIS #001
üìç Localiza√ß√£o: /api/users/getUserByEmail.js:45
üìä Tipo: SELECT com WHERE clause
‚ö° Performance: 
  - √çndice em 'email': ‚úÖ Existente
  - √çndice em 'active': ‚ùå Ausente
  - Estimativa: ~150ms (LENTO)
  - Registros afetados: ~1000
üîß Otimiza√ß√£o sugerida: 
  - Criar √≠ndice composto (email, active)
  - Evitar SELECT *
  - Usar pagina√ß√£o
üìà Impacto: Redu√ß√£o de 150ms ‚Üí 5ms
```

#### 2.2 An√°lise de Estrutura de Dados
- Normaliza√ß√£o vs denormaliza√ß√£o
- √çndices existentes vs necess√°rios
- Chaves estrangeiras e integridade
- Triggers e stored procedures
- Backups e recovery
- Migrations e versionamento

#### 2.3 An√°lise de Seguran√ßa da BD
- Prote√ß√£o contra SQL injection
- Permiss√µes de utilizador da BD
- Encripta√ß√£o de dados sens√≠veis
- Auditoria de acessos
- Conex√µes seguras (SSL/TLS)

### üß© FASE 3: MAPEAMENTO ARQUITETURAL COMPLETO

#### 3.1 Invent√°rio Molecular de Ficheiros
**Para CADA ficheiro:**
```
üìÑ FICHEIRO: /src/components/UserProfile.jsx
üìè Tamanho: 2.3KB (145 linhas)
üîó Imports: 8 depend√™ncias
üéØ Exports: 1 componente principal + 2 helpers
üìä Complexidade: M√©dia (cyclomatic: 12)
üîÑ Utiliza√ß√µes: 3 locais
üí° Estado: Ativo e necess√°rio
üß™ Testes: ‚ùå Ausentes
üìö Documenta√ß√£o: ‚ùå Ausente
üîç Problemas: 2 console.log desnecess√°rios
```

#### 3.2 Mapa de Depend√™ncias Completo
**Gr√°fico de depend√™ncias:**
```
üåê DEPENDENCY GRAPH
‚îú‚îÄ‚îÄ üì¶ react (18.2.0)
‚îÇ   ‚îú‚îÄ‚îÄ üß© UserProfile.jsx
‚îÇ   ‚îú‚îÄ‚îÄ üß© Dashboard.jsx
‚îÇ   ‚îî‚îÄ‚îÄ üß© LoginForm.jsx
‚îú‚îÄ‚îÄ üì¶ axios (1.4.0)
‚îÇ   ‚îú‚îÄ‚îÄ üîß api/userService.js
‚îÇ   ‚îú‚îÄ‚îÄ üîß api/authService.js
‚îÇ   ‚îî‚îÄ‚îÄ ‚ùå N√ÉO USADO: api/oldService.js
‚îî‚îÄ‚îÄ üì¶ lodash (4.17.21)
    ‚îú‚îÄ‚îÄ üîß utils/helpers.js
    ‚îî‚îÄ‚îÄ ‚ö†Ô∏è SUBUTILIZADO: apenas 2 fun√ß√µes de 300+
```

#### 3.3 An√°lise COMPLETA de Cada P√°gina Individual
**OBRIGAT√ìRIO: Para CADA p√°gina encontrada, criar an√°lise detalhada:**

```
üìÑ P√ÅGINA: /admin/users (AdminUsers.jsx)
üìç Localiza√ß√£o: /src/pages/AdminUsers.jsx
üìè Tamanho: 3.2KB (189 linhas)
üîê Prote√ß√£o: ‚úÖ RequireAuth + AdminRole
üìä Tr√°fego: 15 acessos/dia
üîó Links entrada: 3 locais
üì± Responsiva: ‚úÖ Sim
‚ôø Acessibilidade: ‚ö†Ô∏è Parcial (falta alt text)
‚ö° Performance: 850ms load time (LENTO)
üß™ Testes: ‚ùå Ausentes
üí° SEO: ‚ùå Meta tags ausentes

üîç PROBLEMAS IDENTIFICADOS:
‚ùå console.log("User data:", userData) - LINHA 45
‚ùå Sem valida√ß√£o de input no campo search - LINHA 67
‚ùå Query SQL lenta: getUsersWithRoles() - LINHA 89
‚ùå Re-render desnecess√°rio a cada keystroke - LINHA 23
‚ùå Sem error boundaries - GERAL
‚ùå CSS n√£o otimizado: 45KB carregados, 12KB usados - STYLES
‚ùå Sem lazy loading de tabela - LINHA 112
‚ùå Falta loading states - LINHA 134

üí° MELHORIAS ESPEC√çFICAS:
1. Remover console.log da linha 45
2. Adicionar valida√ß√£o Joi/Yup no campo search
3. Implementar √≠ndice composto na query getUsersWithRoles
4. Usar useDebounce para search input
5. Adicionar ErrorBoundary component
6. Implementar CSS tree-shaking
7. Adicionar React.lazy() para tabela
8. Implementar skeleton loading

‚è±Ô∏è ESTIMATIVA CORRE√á√ÉO: 4 horas
üí∞ IMPACTO PERFORMANCE: +300ms velocidade
üéØ PRIORIDADE: ALTA (dados sens√≠veis expostos)
```

**REPETIR ESTA AN√ÅLISE PARA CADA P√ÅGINA SEM EXCE√á√ÉO**

### ‚ö° FASE 4: AN√ÅLISE DE PERFORMANCE MICROSC√ìPICA

#### 4.1 An√°lise de Bundle e Assets
- Tamanho total do bundle
- Code splitting implementado
- Lazy loading de componentes
- Compression de assets
- Otimiza√ß√£o de imagens
- Fonts e icons otimizados
- Service workers implementados

#### 4.2 An√°lise de Rendering
**Para cada componente:**
```
üé® COMPONENT RENDER ANALYSIS: UserList.jsx
üîÑ Re-renders: 15 por minuto (EXCESSIVO)
üìä Props changes: 8 desnecess√°rias
üêå Bottleneck: map() sem key otimizada
üíæ Memoiza√ß√£o: ‚ùå Ausente
üîß Sugest√µes:
  - React.memo() implementation
  - useMemo() for expensive calculations
  - useCallback() for event handlers
üìà Impacto: -60% re-renders
```

#### 4.3 An√°lise de Network
- N√∫mero de requests por p√°gina
- Tamanho dos requests
- Cache headers configurados
- CDN implementado
- API response times
- Waterfall de carregamento

### üîç FASE 5: AN√ÅLISE DE C√ìDIGO MORTO E REDUNDANTE

#### 5.1 Dead Code Detection
**Algoritmo de detec√ß√£o:**
1. Mapear todas as importa√ß√µes
2. Rastrear todas as utiliza√ß√µes
3. Identificar c√≥digo inalcan√ß√°vel
4. Encontrar fun√ß√µes n√£o chamadas
5. Localizar vari√°veis n√£o utilizadas
6. Detectar CSS n√£o usado

**Formato de reporte:**
```
üíÄ DEAD CODE DETECTED
üìÅ Arquivo: /utils/oldHelpers.js
üìä Tamanho: 1.2KB
üïê √öltima modifica√ß√£o: 2023-06-15
üîç Raz√£o: Fun√ß√£o exportada mas nunca importada
üí∞ Impacto: Redu√ß√£o de 1.2KB no bundle
üóëÔ∏è A√ß√£o: REMOVER SEGURAMENTE
```

#### 5.2 An√°lise de Duplica√ß√£o
- C√≥digo duplicado entre componentes
- L√≥gica repetida
- Estilos CSS duplicados
- Fun√ß√µes similares
- Componentes redundantes

### üß™ FASE 6: AN√ÅLISE DE TESTES E QUALIDADE

#### 6.1 Cobertura de Testes
- Percentagem de cobertura por arquivo
- Tipos de testes (unit, integration, e2e)
- Testes cr√≠ticos ausentes
- Qualidade dos testes existentes
- Mocking e stubbing adequados

#### 6.2 An√°lise de Code Quality
- Complexidade ciclom√°tica
- Padr√µes de naming
- Consistent code style
- Documentation coverage
- Error handling patterns
- Logging patterns

### üî• FASE 8: AN√ÅLISE DE VULNERABILIDADES AVAN√áADAS

#### 8.1 Testes de Penetra√ß√£o Automatizados
**Verificar atrav√©s de:**
- OWASP ZAP scanning
- Burp Suite analysis
- Nmap port scanning
- SQLMap injection tests
- XSS payload testing
- CSRF token validation
- Session fixation tests
- Directory traversal attempts

#### 8.2 An√°lise de Depend√™ncias Vulner√°veis
**Para cada depend√™ncia:**
```
üì¶ DEPENDENCY VULNERABILITY SCAN
üìç Package: express@4.17.1
üö® CVE: CVE-2022-24999
‚ö†Ô∏è Severity: HIGH
üîç Description: ReDoS vulnerability in Express.js
üí° Fix: Upgrade to express@4.18.2
üìÖ Published: 2022-03-15
üéØ CVSS Score: 7.5
```

#### 8.3 An√°lise de Configura√ß√£o de Servidor
- Server headers disclosure
- Error page information leakage
- Admin interfaces exposed
- Default credentials usage
- SSL/TLS configuration strength
- HTTP security headers
- Content Security Policy adequacy

### üé® FASE 9: AN√ÅLISE DE UX/UI E ACESSIBILIDADE

#### 9.1 Auditoria de Acessibilidade (WCAG 2.1)
**Para cada p√°gina:**
```
‚ôø ACCESSIBILITY AUDIT: /contact
üìä WCAG Level: AA Target
üîç Issues encontradas:
‚ùå Contraste insuficiente: bot√£o azul #3498db (3.2:1 - m√≠nimo 4.5:1)
‚ùå Falta alt text: imagem linha 67
‚ùå Sem focus indicators: inputs do form
‚ùå Heading hierarchy incorreta: h1 ‚Üí h3 (saltou h2)
‚ùå Sem labels para form inputs
‚ùå Tab order inconsistente

üí° Corre√ß√µes:
1. Alterar cor bot√£o para #2980b9 (4.7:1)
2. Adicionar alt="√çcone de contacto" na linha 67
3. Implementar :focus-visible styles
4. Adicionar h2 antes do h3 existente
5. Adicionar <label> para cada input
6. Configurar tabindex adequadamente
```

#### 9.2 An√°lise de Performance UX
- Core Web Vitals detalhados
- Loading states implementados
- Error states adequados
- Empty states design
- Skeleton screens
- Progressive loading
- Image optimization
- Font loading strategy

#### 9.3 An√°lise de Mobile Experience
- Touch target sizes (m√≠nimo 44px)
- Viewport configuration
- Mobile-first design
- Gesture navigation
- Offline functionality
- App-like experience (PWA)

### üåê FASE 10: AN√ÅLISE DE SEO E MARKETING

#### 10.1 Technical SEO Audit
**Para cada p√°gina:**
```
üîç SEO AUDIT: /products
üìä SEO Score: 65/100 (M√âDIO)
‚ùå Title tag: Ausente
‚ùå Meta description: Ausente  
‚ùå H1 tag: Duplicado (2 H1s)
‚ùå Alt text: 12 imagens sem alt
‚ùå Schema markup: Ausente
‚ùå Canonical URL: Ausente
‚úÖ URL structure: Adequada
‚úÖ HTTPS: Implementado
‚ö†Ô∏è Page speed: 2.3s (LENTO)
‚ö†Ô∏è Mobile friendly: Parcial

üí° Corre√ß√µes:
1. Adicionar title √∫nico: "Produtos - Loja Miguel"
2. Meta description: "Descubra nossa linha completa..."
3. Converter segundo H1 para H2
4. Adicionar alt text descritivo
5. Implementar JSON-LD schema
6. Adicionar canonical link
7. Otimizar imagens (WebP)
8. Implementar lazy loading
```

#### 10.2 An√°lise de Marketing Digital
- Google Analytics implementa√ß√£o
- Facebook Pixel tracking
- Google Tag Manager setup
- Conversion tracking
- A/B testing framework
- Email capture optimization
- Social media integration

### üíæ FASE 11: AN√ÅLISE DE DADOS E BACKUP

#### 11.1 Data Management Audit
- Database backup frequency
- Data retention policies
- Data encryption at rest
- Data encryption in transit
- Personal data handling
- Data export capabilities
- Data import validation
- Data migration scripts

#### 11.2 Business Continuity
- Disaster recovery plan
- High availability setup
- Load balancing configuration
- CDN implementation
- Monitoring and alerting
- Incident response procedures

#### 7.1 Error Tracking
- Sistema de error tracking implementado
- Logs de aplica√ß√£o estruturados
- Monitoring de performance
- Alertas configurados
- M√©tricas de neg√≥cio

#### 7.2 Analytics e M√©tricas
- User behavior tracking
- Performance metrics
- Business metrics
- Conversion tracking
- A/B testing setup

---

## üìã ESTRUTURA DO DOCUMENTO FINAL

### 1. üìä DASHBOARD EXECUTIVO
```
üéØ PROJETO: [Nome do projeto]
üìÖ DATA AUDITORIA: [Data]
üë®‚Äçüíª AUDITOR: AI Assistant
üìä RESUMO CR√çTICO:
  - üö® Problemas cr√≠ticos: X
  - ‚ö†Ô∏è Problemas m√©dios: Y  
  - üí° Melhorias sugeridas: Z
  - üí∞ Impacto estimado: ‚Ç¨‚Ç¨‚Ç¨
```

### 2. üõ°Ô∏è RELAT√ìRIO DE SEGURAN√áA
#### 2.1 Vulnerabilidades Cr√≠ticas
[Lista detalhada com localiza√ß√£o exata]

#### 2.2 Dados Sens√≠veis Expostos
[Todos os casos encontrados]

#### 2.3 Plano de Corre√ß√£o Imediata
[A√ß√µes priorit√°rias]

### 3. üóÉÔ∏è MAPA COMPLETO DO PROJETO
#### 3.1 Estrutura de Arquivos
```
üìÅ PROJECT STRUCTURE
‚îú‚îÄ‚îÄ üìÅ src/
‚îÇ   ‚îú‚îÄ‚îÄ üìÅ components/ (45 arquivos)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ‚úÖ Header.jsx (ATIVO - 12 usos)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ‚úÖ Footer.jsx (ATIVO - 8 usos)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ‚ö†Ô∏è OldModal.jsx (DEPRECATED - 1 uso)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ‚ùå UnusedButton.jsx (MORTO - 0 usos)
‚îÇ   ‚îú‚îÄ‚îÄ üìÅ pages/ (23 arquivos)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ‚úÖ Dashboard.jsx (ATIVO - rota principal)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ‚ö†Ô∏è AdminPanel.jsx (RESTRITO - poucos acessos)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ‚ùå OldLanding.jsx (MORTO - sem refer√™ncias)
‚îÇ   ‚îî‚îÄ‚îÄ üìÅ utils/ (12 arquivos)
‚îÇ       ‚îú‚îÄ‚îÄ ‚úÖ helpers.js (ATIVO - 89 usos)
‚îÇ       ‚îî‚îÄ‚îÄ ‚ùå oldUtils.js (MORTO - 0 usos)
‚îî‚îÄ‚îÄ üìÅ public/ (assets analysis)
```

#### 3.2 Componentes por Utiliza√ß√£o
[Lista ordenada por frequ√™ncia de uso]

#### 3.3 P√°ginas por Tr√°fego
[Lista ordenada por acessos]

### 4. üóÑÔ∏è AN√ÅLISE DE BASE DE DADOS
#### 4.1 Performance Report
[Todas as queries analisadas]

#### 4.2 Otimiza√ß√µes Sugeridas
[Plano detalhado de melhorias]

### 5. ‚ö° RELAT√ìRIO DE PERFORMANCE
#### 5.1 M√©tricas Atuais
- First Contentful Paint: Xms
- Largest Contentful Paint: Xms
- Cumulative Layout Shift: X
- Time to Interactive: Xms

#### 5.2 Bottlenecks Identificados
[Lista detalhada com solu√ß√µes]

### 6. üíÄ C√ìDIGO MORTO IDENTIFICADO
#### 6.1 Arquivos N√£o Utilizados
[Lista completa para remo√ß√£o]

#### 6.2 Fun√ß√µes N√£o Chamadas
[Detalhes de cada fun√ß√£o]

#### 6.3 Depend√™ncias Desnecess√°rias
[Package.json cleanup]

### 7. üîß PLANO DE A√á√ÉO DETALHADO
#### 7.1 Corre√ß√µes Imediatas (24h)
```
‚ñ° Remover todos os console.log com dados sens√≠veis
‚ñ° Implementar headers de seguran√ßa b√°sicos
‚ñ° Corrigir vulnerabilidades cr√≠ticas
‚ñ° Remover arquivos mortos √≥bvios
```

#### 7.2 Melhorias Curto Prazo (1 semana)
```
‚ñ° Otimizar queries lentas identificadas
‚ñ° Implementar lazy loading
‚ñ° Consolidar componentes similares
‚ñ° Adicionar testes cr√≠ticos
```

#### 7.3 Refatora√ß√£o M√©dio Prazo (1 m√™s)
```
‚ñ° Reestruturar arquitetura de componentes
‚ñ° Implementar state management adequado
‚ñ° Otimizar bundle size
‚ñ° Melhorar documenta√ß√£o
```

#### 7.4 Evolu√ß√£o Longo Prazo (3+ meses)
```
‚ñ° Migra√ß√£o para arquitetura moderna
‚ñ° Implementar micro-frontends se necess√°rio
‚ñ° Setup completo de CI/CD
‚ñ° Monitoriza√ß√£o avan√ßada
```

### 8. üí∞ AN√ÅLISE DE IMPACTO
#### 8.1 Economia Estimada
- Redu√ß√£o de custos de infraestrutura
- Melhoria de performance
- Redu√ß√£o de bugs
- Economia de tempo de desenvolvimento

#### 8.2 ROI das Melhorias
[C√°lculo detalhado do retorno]

### 9. üéØ RECOMENDA√á√ïES ESTRAT√âGICAS
#### 9.1 Tecnologias a Considerar
[Stack moderno sugerido]

#### 9.2 Melhores Pr√°ticas
[Guidelines para o futuro]

### 10. üìà PLANO DE MONITORIZA√á√ÉO
#### 10.1 M√©tricas a Implementar
[KPIs t√©cnicos e de neg√≥cio]

#### 10.2 Alertas e Notifica√ß√µes
[Sistema de monitoriza√ß√£o]

---

## üéØ INSTRU√á√ïES DE EXECU√á√ÉO

### üéØ INSTRU√á√ïES DE EXECU√á√ÉO ULTRA-RIGOROSAS

### 1. AN√ÅLISE P√ÅGINA POR P√ÅGINA OBRIGAT√ìRIA
**CADA p√°gina deve ter an√°lise individual completa:**
```
üìÑ TEMPLATE DE AN√ÅLISE POR P√ÅGINA:
P√°gina: [nome]
Localiza√ß√£o: [path exato]
Fun√ß√£o: [prop√≥sito da p√°gina]
Problemas: [lista detalhada]
Melhorias: [solu√ß√µes espec√≠ficas]
Prioridade: [alta/m√©dia/baixa]
Tempo estimado: [horas]
```

### 2. VERIFICA√á√ÉO DE PRECAU√á√ïES DE SISTEMA
**Checklist obrigat√≥rio:**
- [ ] Todos os console.log identificados
- [ ] Todas as vari√°veis de ambiente verificadas
- [ ] Todos os endpoints API testados
- [ ] Todas as queries SQL auditadas
- [ ] Todos os uploads de ficheiros verificados
- [ ] Todas as autentica√ß√µes validadas
- [ ] Todos os acessos administrativos verificados
- [ ] Todas as integra√ß√µes de terceiros auditadas
- [ ] Todos os logs de sistema analisados
- [ ] Todas as configura√ß√µes de servidor verificadas

### 3. AN√ÅLISE DE CADA PROBLEMA INDIVIDUAL
**Para cada problema encontrado:**
```
üîç PROBLEMA #XXX
üìç Localiza√ß√£o: arquivo.js:linha
üö® Tipo: [seguran√ßa/performance/manuten√ß√£o]
üíÄ Descri√ß√£o: [explica√ß√£o detalhada]
üí° Solu√ß√£o: [passos espec√≠ficos]
‚è±Ô∏è Tempo: [estimativa]
üéØ Prioridade: [justifica√ß√£o]
üìä Impacto: [m√©trica espec√≠fica]
```

### 4. PLANO DE MELHORIA DETALHADO
**Cada melhoria deve incluir:**
- C√≥digo espec√≠fico a alterar
- Antes vs depois
- Testes a implementar
- Valida√ß√£o da corre√ß√£o
- Impacto na performance
- Riscos da altera√ß√£o

### 2. FORMATO DE DOCUMENTA√á√ÉO
- Usar emojis para categoriza√ß√£o visual
- Incluir sempre localiza√ß√£o exata (arquivo:linha)
- Priorizar por criticidade (üö® > ‚ö†Ô∏è > üí°)
- Incluir estimativas de tempo/impacto
- Fornecer solu√ß√µes concretas

### 3. M√âTRICAS OBRIGAT√ìRIAS
Para cada arquivo analisado:
- Tamanho em KB
- N√∫mero de linhas
- Complexidade ciclom√°tica
- N√∫mero de depend√™ncias
- Frequ√™ncia de utiliza√ß√£o
- Problemas encontrados
- Sugest√µes de melhoria

### 4. VERIFICA√á√ïES ESPEC√çFICAS
- [ ] Todos os console.log verificados
- [ ] Todas as queries SQL analisadas
- [ ] Todos os componentes mapeados
- [ ] Todas as rotas documentadas
- [ ] Todas as depend√™ncias auditadas
- [ ] Todos os assets verificados
- [ ] Toda a estrutura de pastas mapeada

### 5. ENTREGA FINAL
Documento "AUDITORIA_COMPLETA_MIGUELLOPES.md" deve conter:
- M√≠nimo 50 p√°ginas de an√°lise detalhada
- M√°ximo 200 problemas identificados
- Plano de a√ß√£o com 100+ tarefas espec√≠ficas
- Estimativas de tempo para cada corre√ß√£o
- Impacto financeiro das melhorias

---

## üî• COME√áAR AN√ÅLISE AGORA

**IN√çCIO IMEDIATO:**
1. Fazer scan completo de todos os arquivos
2. Identificar IMEDIATAMENTE qualquer console.log
3. Mapear estrutura completa do projeto
4. Analisar cada query SQL encontrada
5. Gerar relat√≥rio ultra-detalhado

**LEMBRETE CR√çTICO:** Esta an√°lise deve ser a mais completa poss√≠vel. N√£o deixar NENHUM detalhe por analisar. O Miguel Lopes precisa de uma vis√£o 360¬∞ completa do seu projeto.
---
